<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>app.rs - async-template</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./mdbook-admonish.css">
        <link rel="stylesheet" href="./theme/catppuccin.css">
        <link rel="stylesheet" href="./theme/catppuccin-highlight.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Home</a></li><li class="chapter-item expanded "><a href="00-structure.html"><strong aria-hidden="true">2.</strong> Tutorial</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="01-structure.html"><strong aria-hidden="true">2.1.</strong> main.rs</a></li><li class="chapter-item expanded "><a href="02-structure.html"><strong aria-hidden="true">2.2.</strong> tui.rs</a></li><li class="chapter-item expanded "><a href="03-structure.html"><strong aria-hidden="true">2.3.</strong> action.rs</a></li><li class="chapter-item expanded "><a href="04-structure.html" class="active"><strong aria-hidden="true">2.4.</strong> app.rs</a></li><li class="chapter-item expanded "><a href="05-structure.html"><strong aria-hidden="true">2.5.</strong> components.rs</a></li><li class="chapter-item expanded "><a href="06-structure.html"><strong aria-hidden="true">2.6.</strong> components/home.rs</a></li><li class="chapter-item expanded "><a href="07-structure.html"><strong aria-hidden="true">2.7.</strong> config.rs</a></li><li class="chapter-item expanded "><a href="08-structure.html"><strong aria-hidden="true">2.8.</strong> utils.rs</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="latte">Latte</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="frappe">Frappé</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="macchiato">Macchiato</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mocha">Mocha</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">async-template</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ratatui-org/async-template" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ratatui-org/async-template/edit/main/book/src/04-structure.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="apprs"><a class="header" href="#apprs"><code>app.rs</code></a></h1>
<p>Finally, putting all the pieces together, we are almost ready to get the <code>Run</code> struct. Before we do,
we should discuss the process of a TUI.</p>
<p>Most TUIs are single process, single threaded applications.</p>
<pre class="svgbob"><style>text{fill:var(--fg)}</style><svg xmlns="http://www.w3.org/2000/svg" width="136" height="224">
  <style>
    line, path, circle, rect, polygon{stroke:var(--fg);stroke-width:2;stroke-opacity:1;fill-opacity:1;stroke-linecap:round;stroke-linejoin:miter;}text{font-family:Iosevka Fixed, monospace;font-size:14px;}rect.backdrop{stroke:none;fill:transparent;}.broken{stroke-dasharray:8;}.filled{fill:black;}.bg_filled{fill:transparent;}.nofill{fill:transparent;}.end_marked_arrow{marker-end:url(#arrow);}.start_marked_arrow{marker-start:url(#arrow);}.end_marked_diamond{marker-end:url(#diamond);}.start_marked_diamond{marker-start:url(#diamond);}.end_marked_circle{marker-end:url(#circle);}.start_marked_circle{marker-start:url(#circle);}.end_marked_open_circle{marker-end:url(#open_circle);}.start_marked_open_circle{marker-start:url(#open_circle);}.end_marked_big_open_circle{marker-end:url(#big_open_circle);}.start_marked_big_open_circle{marker-start:url(#big_open_circle);}
    <!--separator-->
    
  </style>
  <defs>
    <marker id="arrow" viewBox="-2 -2 8 8" refX="4" refY="2" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <polygon points="0,0 0,4 4,2 0,0"></polygon>
    </marker>
    <marker id="diamond" viewBox="-2 -2 8 8" refX="4" refY="2" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <polygon points="0,2 2,0 4,2 2,4 0,2"></polygon>
    </marker>
    <marker id="circle" viewBox="0 0 8 8" refX="4" refY="4" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <circle cx="4" cy="4" r="2" class="filled"></circle>
    </marker>
    <marker id="open_circle" viewBox="0 0 8 8" refX="4" refY="4" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <circle cx="4" cy="4" r="2" class="bg_filled"></circle>
    </marker>
    <marker id="big_open_circle" viewBox="0 0 8 8" refX="4" refY="4" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <circle cx="4" cy="4" r="3" class="bg_filled"></circle>
    </marker>
  </defs>
  <rect class="backdrop" x="0" y="0" width="136" height="224"></rect>
  <text x="18" y="28" >Get</text>
  <text x="50" y="28" >Key</text>
  <text x="82" y="28" >Event</text>
  <text x="18" y="108" >Update</text>
  <text x="74" y="108" >State</text>
  <text x="42" y="188" >Draw</text>
  <g>
    <path d="M 16,8 A 4,4 0,0,0 12,12" class="nofill"></path>
    <line x1="12" y1="12" x2="12" y2="36" class="solid"></line>
    <line x1="16" y1="8" x2="120" y2="8" class="solid"></line>
    <path d="M 120,8 A 4,4 0,0,1 124,12" class="nofill"></path>
    <line x1="124" y1="12" x2="124" y2="36" class="solid"></line>
    <path d="M 12,36 A 4,4 0,0,0 16,40" class="nofill"></path>
    <line x1="16" y1="40" x2="120" y2="40" class="solid"></line>
    <line x1="60" y1="40" x2="60" y2="84" class="solid"></line>
    <path d="M 124,36 A 4,4 0,0,1 120,40" class="nofill"></path>
    <polygon points="56,84 64,84 60,96" class="filled"></polygon>
  </g>
  <g>
    <path d="M 16,88 A 4,4 0,0,0 12,92" class="nofill"></path>
    <line x1="12" y1="92" x2="12" y2="116" class="solid"></line>
    <line x1="16" y1="88" x2="56" y2="88" class="solid"></line>
    <path d="M 12,116 A 4,4 0,0,0 16,120" class="nofill"></path>
    <line x1="16" y1="120" x2="112" y2="120" class="solid"></line>
    <line x1="60" y1="120" x2="60" y2="164" class="solid"></line>
    <polygon points="56,164 64,164 60,176" class="filled"></polygon>
    <line x1="64" y1="88" x2="112" y2="88" class="solid"></line>
    <path d="M 112,88 A 4,4 0,0,1 116,92" class="nofill"></path>
    <line x1="116" y1="92" x2="116" y2="116" class="solid"></line>
    <path d="M 116,116 A 4,4 0,0,1 112,120" class="nofill"></path>
  </g>
  <g>
    <path d="M 32,168 A 4,4 0,0,0 28,172" class="nofill"></path>
    <line x1="28" y1="172" x2="28" y2="196" class="solid"></line>
    <line x1="32" y1="168" x2="56" y2="168" class="solid"></line>
    <path d="M 28,196 A 4,4 0,0,0 32,200" class="nofill"></path>
    <line x1="32" y1="200" x2="88" y2="200" class="solid"></line>
    <line x1="64" y1="168" x2="88" y2="168" class="solid"></line>
    <path d="M 88,168 A 4,4 0,0,1 92,172" class="nofill"></path>
    <line x1="92" y1="172" x2="92" y2="196" class="solid"></line>
    <path d="M 92,196 A 4,4 0,0,1 88,200" class="nofill"></path>
  </g>
</svg></pre>
<p>When an application is structured like this, the TUI is blocking at each step:</p>
<ol>
<li>Waiting for a Event.
<ul>
<li>If no key or mouse event in 250ms, send <code>Tick</code>.</li>
</ul>
</li>
<li>Update the state of the app based on <code>event</code> or <code>action</code>.</li>
<li><code>draw</code> the state of the app to the terminal using <code>ratatui</code>.</li>
</ol>
<p>This works perfectly fine for small applications, and this is what I recommend starting out with.
For <em>most</em> TUIs, you’ll never need to graduate from this process methodology.</p>
<p>Usually, <code>draw</code> and <code>get_events</code> are fast enough that it doesn’t matter. But if you do need to do a
computationally demanding or I/O intensive task while updating state (e.g. reading a database,
computing math or making a web request), your app may “hang” while it is doing so.</p>
<p>Let’s say a user presses <code>j</code> to scroll down a list. And every time the user presses <code>j</code> you want to
check the web for additional items to add to the list.</p>
<p>What should happen when a user presses and holds <code>j</code>? It is up to you to decide how you would like
your TUI application to behave in that instance.</p>
<p>You may decide that the desired behavior for your app is to hang while downloading new elements for
the list, and all key presses while the app hangs are received and handled “instantly” after the
download completes.</p>
<p>Or you may decide to <code>flush</code> all keyboard events so they are not buffered, and you may want to
implement something like the following:</p>
<pre><code class="language-rust">let mut app = App::new();
loop {
  // ...
  let before_draw = Instant::now();
  t.terminal.draw(|f| self.render(f))?;
  // If drawing to the terminal is slow, flush all keyboard events so they're not buffered.
  if before_draw.elapsed() &gt; Duration::from_millis(20) {
      while let Ok(_) = events.try_next() {}
  }
  // ...
}</code></pre>
<p>Alternatively, you may decide you want the app to update in the background, and a user should be
able to scroll through the existing list while the app is downloading new elements.</p>
<p>In my experience, the trade-off is here is usually complexity for the developer versus ergonomics
for the user.</p>
<p>Let’s say we weren’t worried about complexity, and were interested in performing a computationally
demanding or I/O intensive task in the background. For our example, let’s say that we wanted to
trigger a increment to the counter after sleeping for <code>5</code> seconds.</p>
<p>This means that we’ll have to start a “task” that sleeps for 5 seconds, and then sends another
<code>Action</code> to be dispatched on.</p>
<p>Now, our <code>update()</code> method takes the following shape:</p>
<pre><code class="language-rust">  fn update(&amp;mut self, action: Action) -&gt; Option&lt;Action&gt; {
    match action {
      Action::Tick =&gt; self.tick(),
      Action::ScheduleIncrement =&gt; self.schedule_increment(1),
      Action::ScheduleDecrement =&gt; self.schedule_decrement(1),
      Action::Increment(i) =&gt; self.increment(i),
      Action::Decrement(i) =&gt; self.decrement(i),
      _ =&gt; (),
    }
    None
  }</code></pre>
<p>And <code>schedule_increment()</code> and <code>schedule_decrement()</code> both spawn short lived <code>tokio</code> tasks:</p>
<pre><code class="language-rust">  pub fn schedule_increment(&amp;mut self, i: i64) {
    let tx = self.action_tx.clone().unwrap();
    tokio::spawn(async move {
      tokio::time::sleep(Duration::from_secs(5)).await;
      tx.send(Action::Increment(i)).unwrap();
    });
  }

  pub fn schedule_decrement(&amp;mut self, i: i64) {
    let tx = self.action_tx.clone().unwrap();
    tokio::spawn(async move {
      tokio::time::sleep(Duration::from_secs(5)).await;
      tx.send(Action::Decrement(i)).unwrap();
    });
  }

  pub fn increment(&amp;mut self, i: i64) {
    self.counter += i;
  }

  pub fn decrement(&amp;mut self, i: i64) {
    self.counter -= i;
  }
</code></pre>
<p>In order to do this, we want to set up a <code>action_tx</code> on the <code>App</code> struct:</p>
<pre><code class="language-rust">#[derive(Default)]
struct App {
  counter: i64,
  should_quit: bool,
  action_tx: Option&lt;UnboundedSender&lt;Action&gt;&gt;
}</code></pre>
<div id="admonition-note" class="admonition note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="#admonition-note"></a></p>
</div>
<div>
<p>The only reason we are using an <code>Option&lt;T&gt;</code> here for <code>action_tx</code> is that we are not initializing the action channel when creating the instance of the <code>App</code>.</p>
</div>
</div>
<p>This is what we want to do:</p>
<pre><code class="language-rust">  pub async fn run(&amp;mut self) -&gt; Result&lt;()&gt; {
    let (action_tx, mut action_rx) = mpsc::unbounded_channel();
    let t = Tui::new();
    t.enter();

    tokio::spawn(async move {
      let mut event = EventHandler::new(250);
      loop {
        let event = event.next().await;
        let action = self.handle_events(event); // ERROR: self is moved to this tokio task
        action_tx.send(action);
      }
    })

    loop {
      if let Some(action) = action_rx.recv().await {
        self.update(action);
      }
      t.terminal.draw(|f| self.render(f))?;
      if self.should_quit {
        break
      }
    }
    t.exit();
    Ok(())
  }</code></pre>
<p>However, this doesn’t quite work because we can’t move <code>self</code>, i.e. the <code>App</code> to the
<code>event -&gt; action</code> mapping, i.e. <code>self.handle_events()</code>, and still use it later for <code>self.update()</code>.</p>
<p>One way to solve this is to pass a <code>Arc&lt;Mutex&lt;App&gt;</code> instance to the <code>event -&gt; action</code> mapping loop,
where it uses a <code>lock()</code> to get a reference to the object to call <code>obj.handle_events()</code>. We’ll have
to use the same <code>lock()</code> functionality in the main loop as well to call <code>obj.update()</code>.</p>
<pre><code class="language-rust">pub struct App {
  pub component: Arc&lt;Mutex&lt;App&gt;&gt;,
  pub should_quit: bool,
}

impl App {
  pub async fn run(&amp;mut self) -&gt; Result&lt;()&gt; {
    let (action_tx, mut action_rx) = mpsc::unbounded_channel();

    let tui = Tui::new();
    tui.enter();

    tokio::spawn(async move {
      let component = self.component.clone();
      let mut event = EventHandler::new(250);
      loop {
        let event = event.next().await;
        let action = component.lock().await.handle_events(event);
        action_tx.send(action);
      }
    })

    loop {
      if let Some(action) = action_rx.recv().await {
        match action {
          Action::Render =&gt; {
            let c = self.component.lock().await;
            t.terminal.draw(|f| c.render(f))?;
          };
          Action::Quit =&gt; self.should_quit = true,
          _ =&gt; self.component.lock().await.update(action),
        }
      }
      self.should_quit {
        break;
      }
    }

    tui.exit();
    Ok(())
  }
}</code></pre>
<p>Now our <code>App</code> is generic boilerplate that doesn’t depend on any business logic. It is responsible
just to drive the application forward, i.e. call appropriate functions.</p>
<p>We can go one step further and make the render loop its own <code>tokio</code> task:</p>
<pre><code class="language-rust">pub struct App {
  pub component: Arc&lt;Mutex&lt;Home&gt;&gt;,
  pub should_quit: bool,
}

impl App {
  pub async fn run(&amp;mut self) -&gt; Result&lt;()&gt; {
    let (render_tx, mut render_rx) = mpsc::unbounded_channel();

    tokio::spawn(async move {
      let component = self.component.clone();
      let tui = Tui::new();
      tui.enter();
      loop {
        if let Some(_) = render_rx.recv() {
          let c = self.component.lock().await;
          tui.terminal.draw(|f| c.render(f))?;
        }
      }
      tui.exit()
    })

    let (action_tx, mut action_rx) = mpsc::unbounded_channel();

    tokio::spawn(async move {
      let component = self.component.clone();
      let mut event = EventHandler::new(250);
      loop {
        let event = event.next().await;
        let action = component.lock().await.handle_events(event);
        action_tx.send(action);
      }
    })

    loop {
      if let Some(action) = action_rx.recv().await {
        match action {
          Action::Render =&gt; {
            render_tx.send(());
          };
          Action::Quit =&gt; self.should_quit = true,
          _ =&gt; self.component.lock().await.update(action),
        }
      }
      self.should_quit {
        break;
      }
    }

    Ok(())
  }
}</code></pre>
<p>Now our final architecture would look like this:</p>
<pre class="svgbob"><style>text{fill:var(--fg)}</style><svg xmlns="http://www.w3.org/2000/svg" width="640" height="352">
  <style>
    line, path, circle, rect, polygon{stroke:var(--fg);stroke-width:2;stroke-opacity:1;fill-opacity:1;stroke-linecap:round;stroke-linejoin:miter;}text{font-family:Iosevka Fixed, monospace;font-size:14px;}rect.backdrop{stroke:none;fill:transparent;}.broken{stroke-dasharray:8;}.filled{fill:black;}.bg_filled{fill:transparent;}.nofill{fill:transparent;}.end_marked_arrow{marker-end:url(#arrow);}.start_marked_arrow{marker-start:url(#arrow);}.end_marked_diamond{marker-end:url(#diamond);}.start_marked_diamond{marker-start:url(#diamond);}.end_marked_circle{marker-end:url(#circle);}.start_marked_circle{marker-start:url(#circle);}.end_marked_open_circle{marker-end:url(#open_circle);}.start_marked_open_circle{marker-start:url(#open_circle);}.end_marked_big_open_circle{marker-end:url(#big_open_circle);}.start_marked_big_open_circle{marker-start:url(#big_open_circle);}
    <!--separator-->
    
  </style>
  <defs>
    <marker id="arrow" viewBox="-2 -2 8 8" refX="4" refY="2" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <polygon points="0,0 0,4 4,2 0,0"></polygon>
    </marker>
    <marker id="diamond" viewBox="-2 -2 8 8" refX="4" refY="2" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <polygon points="0,2 2,0 4,2 2,4 0,2"></polygon>
    </marker>
    <marker id="circle" viewBox="0 0 8 8" refX="4" refY="4" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <circle cx="4" cy="4" r="2" class="filled"></circle>
    </marker>
    <marker id="open_circle" viewBox="0 0 8 8" refX="4" refY="4" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <circle cx="4" cy="4" r="2" class="bg_filled"></circle>
    </marker>
    <marker id="big_open_circle" viewBox="0 0 8 8" refX="4" refY="4" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <circle cx="4" cy="4" r="3" class="bg_filled"></circle>
    </marker>
  </defs>
  <rect class="backdrop" x="0" y="0" width="640" height="352"></rect>
  <text x="34" y="12" >Render</text>
  <text x="90" y="12" >Thread</text>
  <text x="258" y="12" >Event</text>
  <text x="306" y="12" >Thread</text>
  <text x="498" y="12" >Main</text>
  <text x="538" y="12" >Thread</text>
  <text x="258" y="60" >Get</text>
  <text x="290" y="60" >Key</text>
  <text x="322" y="60" >Event</text>
  <text x="242" y="124" >Map</text>
  <text x="274" y="124" >Event</text>
  <text x="322" y="124" >to</text>
  <text x="346" y="124" >Action</text>
  <text x="218" y="188" >Send</text>
  <text x="258" y="188" >Action</text>
  <text x="314" y="188" >on</text>
  <text x="338" y="188" >action</text>
  <line x1="384" y1="192" x2="392" y2="192" class="solid"></line>
  <text x="394" y="188" >tx</text>
  <text x="514" y="188" >Recv</text>
  <text x="554" y="188" >Action</text>
  <text x="18" y="252" >Recv</text>
  <text x="58" y="252" >on</text>
  <text x="82" y="252" >render</text>
  <line x1="128" y1="256" x2="136" y2="256" class="solid"></line>
  <text x="138" y="252" >rx</text>
  <text x="490" y="252" >Dispatch</text>
  <text x="562" y="252" >Action</text>
  <text x="18" y="316" >Render</text>
  <text x="74" y="316" >Component</text>
  <text x="490" y="316" >Update</text>
  <text x="546" y="316" >Component</text>
  <g>
    <path d="M 240,40 A 4,4 0,0,0 236,44" class="nofill"></path>
    <line x1="236" y1="44" x2="236" y2="68" class="solid"></line>
    <line x1="240" y1="40" x2="384" y2="40" class="solid"></line>
    <path d="M 384,40 A 4,4 0,0,1 388,44" class="nofill"></path>
    <line x1="388" y1="44" x2="388" y2="68" class="solid"></line>
    <path d="M 236,68 A 4,4 0,0,0 240,72" class="nofill"></path>
    <line x1="240" y1="72" x2="384" y2="72" class="solid"></line>
    <line x1="308" y1="72" x2="308" y2="100" class="solid"></line>
    <path d="M 388,68 A 4,4 0,0,1 384,72" class="nofill"></path>
    <polygon points="304,100 312,100 308,112" class="filled"></polygon>
  </g>
  <g>
    <path d="M 232,104 A 4,4 0,0,0 228,108" class="nofill"></path>
    <line x1="228" y1="108" x2="228" y2="132" class="solid"></line>
    <line x1="232" y1="104" x2="304" y2="104" class="solid"></line>
    <path d="M 228,132 A 4,4 0,0,0 232,136" class="nofill"></path>
    <line x1="232" y1="136" x2="400" y2="136" class="solid"></line>
    <line x1="308" y1="136" x2="308" y2="164" class="solid"></line>
    <polygon points="304,164 312,164 308,176" class="filled"></polygon>
    <line x1="312" y1="104" x2="400" y2="104" class="solid"></line>
    <path d="M 400,104 A 4,4 0,0,1 404,108" class="nofill"></path>
    <line x1="404" y1="108" x2="404" y2="132" class="solid"></line>
    <path d="M 404,132 A 4,4 0,0,1 400,136" class="nofill"></path>
  </g>
  <g>
    <path d="M 208,168 A 4,4 0,0,0 204,172" class="nofill"></path>
    <line x1="204" y1="172" x2="204" y2="196" class="solid"></line>
    <line x1="208" y1="168" x2="304" y2="168" class="solid"></line>
    <path d="M 204,196 A 4,4 0,0,0 208,200" class="nofill"></path>
    <line x1="208" y1="200" x2="424" y2="200" class="solid"></line>
    <line x1="312" y1="168" x2="424" y2="168" class="solid"></line>
    <path d="M 424,168 A 4,4 0,0,1 428,172" class="nofill"></path>
    <line x1="428" y1="172" x2="428" y2="196" class="solid"></line>
    <line x1="428" y1="184" x2="488" y2="184" class="solid"></line>
    <polygon points="488,180 496,184 488,188" class="filled"></polygon>
    <path d="M 428,196 A 4,4 0,0,1 424,200" class="nofill"></path>
  </g>
  <g>
    <path d="M 504,168 A 4,4 0,0,0 500,172" class="nofill"></path>
    <line x1="500" y1="172" x2="500" y2="196" class="solid"></line>
    <line x1="504" y1="168" x2="608" y2="168" class="solid"></line>
    <path d="M 608,168 A 4,4 0,0,1 612,172" class="nofill"></path>
    <line x1="612" y1="172" x2="612" y2="196" class="solid"></line>
    <path d="M 500,196 A 4,4 0,0,0 504,200" class="nofill"></path>
    <line x1="504" y1="200" x2="608" y2="200" class="solid"></line>
    <line x1="548" y1="200" x2="548" y2="228" class="solid"></line>
    <path d="M 612,196 A 4,4 0,0,1 608,200" class="nofill"></path>
    <polygon points="544,228 552,228 548,240" class="filled"></polygon>
  </g>
  <g>
    <path d="M 8,232 A 4,4 0,0,0 4,236" class="nofill"></path>
    <line x1="4" y1="236" x2="4" y2="260" class="solid"></line>
    <line x1="8" y1="232" x2="160" y2="232" class="solid"></line>
    <path d="M 160,232 A 4,4 0,0,1 164,236" class="nofill"></path>
    <line x1="164" y1="236" x2="164" y2="260" class="solid"></line>
    <path d="M 4,260 A 4,4 0,0,0 8,264" class="nofill"></path>
    <line x1="8" y1="264" x2="160" y2="264" class="solid"></line>
    <line x1="76" y1="264" x2="76" y2="292" class="solid"></line>
    <path d="M 164,260 A 4,4 0,0,1 160,264" class="nofill"></path>
    <polygon points="72,292 80,292 76,304" class="filled"></polygon>
  </g>
  <g>
    <path d="M 480,232 A 4,4 0,0,0 476,236" class="nofill"></path>
    <line x1="476" y1="236" x2="476" y2="260" class="solid"></line>
    <line x1="480" y1="232" x2="544" y2="232" class="solid"></line>
    <path d="M 476,260 A 4,4 0,0,0 480,264" class="nofill"></path>
    <line x1="480" y1="264" x2="616" y2="264" class="solid"></line>
    <line x1="548" y1="264" x2="548" y2="292" class="solid"></line>
    <polygon points="544,292 552,292 548,304" class="filled"></polygon>
    <line x1="552" y1="232" x2="616" y2="232" class="solid"></line>
    <path d="M 616,232 A 4,4 0,0,1 620,236" class="nofill"></path>
    <line x1="620" y1="236" x2="620" y2="260" class="solid"></line>
    <path d="M 620,260 A 4,4 0,0,1 616,264" class="nofill"></path>
    <polygon points="176,244 168,248 176,252" class="filled"></polygon>
    <line x1="176" y1="248" x2="476" y2="248" class="solid"></line>
  </g>
  <g>
    <path d="M 8,296 A 4,4 0,0,0 4,300" class="nofill"></path>
    <line x1="4" y1="300" x2="4" y2="324" class="solid"></line>
    <line x1="8" y1="296" x2="72" y2="296" class="solid"></line>
    <path d="M 4,324 A 4,4 0,0,0 8,328" class="nofill"></path>
    <line x1="8" y1="328" x2="152" y2="328" class="solid"></line>
    <line x1="80" y1="296" x2="152" y2="296" class="solid"></line>
    <path d="M 152,296 A 4,4 0,0,1 156,300" class="nofill"></path>
    <line x1="156" y1="300" x2="156" y2="324" class="solid"></line>
    <path d="M 156,324 A 4,4 0,0,1 152,328" class="nofill"></path>
  </g>
  <g>
    <path d="M 480,296 A 4,4 0,0,0 476,300" class="nofill"></path>
    <line x1="476" y1="300" x2="476" y2="324" class="solid"></line>
    <line x1="480" y1="296" x2="544" y2="296" class="solid"></line>
    <path d="M 476,324 A 4,4 0,0,0 480,328" class="nofill"></path>
    <line x1="480" y1="328" x2="624" y2="328" class="solid"></line>
    <line x1="552" y1="296" x2="624" y2="296" class="solid"></line>
    <path d="M 624,296 A 4,4 0,0,1 628,300" class="nofill"></path>
    <line x1="628" y1="300" x2="628" y2="324" class="solid"></line>
    <path d="M 628,324 A 4,4 0,0,1 624,328" class="nofill"></path>
  </g>
</svg></pre>
<p>You can change around when “thread” or “task” does what in your application if you’d like.</p>
<p>It is up to you to decide is this pattern is worth it. In this template, we are going to keep things
a little simpler. We are going to use just one thread or task to handle all the <code>Event</code>s.</p>
<pre class="svgbob"><style>text{fill:var(--fg)}</style><svg xmlns="http://www.w3.org/2000/svg" width="560" height="224">
  <style>
    line, path, circle, rect, polygon{stroke:var(--fg);stroke-width:2;stroke-opacity:1;fill-opacity:1;stroke-linecap:round;stroke-linejoin:miter;}text{font-family:Iosevka Fixed, monospace;font-size:14px;}rect.backdrop{stroke:none;fill:transparent;}.broken{stroke-dasharray:8;}.filled{fill:black;}.bg_filled{fill:transparent;}.nofill{fill:transparent;}.end_marked_arrow{marker-end:url(#arrow);}.start_marked_arrow{marker-start:url(#arrow);}.end_marked_diamond{marker-end:url(#diamond);}.start_marked_diamond{marker-start:url(#diamond);}.end_marked_circle{marker-end:url(#circle);}.start_marked_circle{marker-start:url(#circle);}.end_marked_open_circle{marker-end:url(#open_circle);}.start_marked_open_circle{marker-start:url(#open_circle);}.end_marked_big_open_circle{marker-end:url(#big_open_circle);}.start_marked_big_open_circle{marker-start:url(#big_open_circle);}
    <!--separator-->
    
  </style>
  <defs>
    <marker id="arrow" viewBox="-2 -2 8 8" refX="4" refY="2" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <polygon points="0,0 0,4 4,2 0,0"></polygon>
    </marker>
    <marker id="diamond" viewBox="-2 -2 8 8" refX="4" refY="2" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <polygon points="0,2 2,0 4,2 2,4 0,2"></polygon>
    </marker>
    <marker id="circle" viewBox="0 0 8 8" refX="4" refY="4" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <circle cx="4" cy="4" r="2" class="filled"></circle>
    </marker>
    <marker id="open_circle" viewBox="0 0 8 8" refX="4" refY="4" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <circle cx="4" cy="4" r="2" class="bg_filled"></circle>
    </marker>
    <marker id="big_open_circle" viewBox="0 0 8 8" refX="4" refY="4" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <circle cx="4" cy="4" r="3" class="bg_filled"></circle>
    </marker>
  </defs>
  <rect class="backdrop" x="0" y="0" width="560" height="224"></rect>
  <text x="58" y="12" >Event</text>
  <text x="106" y="12" >Thread</text>
  <text x="378" y="12" >Main</text>
  <text x="418" y="12" >Thread</text>
  <text x="58" y="60" >Get</text>
  <text x="90" y="60" >Event</text>
  <text x="18" y="124" >Send</text>
  <text x="58" y="124" >Event</text>
  <text x="106" y="124" >on</text>
  <text x="130" y="124" >event</text>
  <line x1="168" y1="128" x2="176" y2="128" class="solid"></line>
  <text x="178" y="124" >tx</text>
  <text x="314" y="124" >Recv</text>
  <text x="354" y="124" >Event</text>
  <text x="402" y="124" >and</text>
  <text x="434" y="124" >Map</text>
  <text x="466" y="124" >to</text>
  <text x="490" y="124" >Action</text>
  <text x="362" y="188" >Update</text>
  <text x="418" y="188" >Component</text>
  <g>
    <path d="M 40,40 A 4,4 0,0,0 36,44" class="nofill"></path>
    <line x1="36" y1="44" x2="36" y2="68" class="solid"></line>
    <line x1="40" y1="40" x2="184" y2="40" class="solid"></line>
    <path d="M 184,40 A 4,4 0,0,1 188,44" class="nofill"></path>
    <line x1="188" y1="44" x2="188" y2="68" class="solid"></line>
    <path d="M 36,68 A 4,4 0,0,0 40,72" class="nofill"></path>
    <line x1="40" y1="72" x2="184" y2="72" class="solid"></line>
    <line x1="108" y1="72" x2="108" y2="100" class="solid"></line>
    <path d="M 188,68 A 4,4 0,0,1 184,72" class="nofill"></path>
    <polygon points="104,100 112,100 108,112" class="filled"></polygon>
  </g>
  <g>
    <path d="M 8,104 A 4,4 0,0,0 4,108" class="nofill"></path>
    <line x1="4" y1="108" x2="4" y2="132" class="solid"></line>
    <line x1="8" y1="104" x2="104" y2="104" class="solid"></line>
    <path d="M 4,132 A 4,4 0,0,0 8,136" class="nofill"></path>
    <line x1="8" y1="136" x2="224" y2="136" class="solid"></line>
    <line x1="112" y1="104" x2="224" y2="104" class="solid"></line>
    <path d="M 224,104 A 4,4 0,0,1 228,108" class="nofill"></path>
    <line x1="228" y1="108" x2="228" y2="132" class="solid"></line>
    <line x1="228" y1="120" x2="288" y2="120" class="solid"></line>
    <polygon points="288,116 296,120 288,124" class="filled"></polygon>
    <path d="M 228,132 A 4,4 0,0,1 224,136" class="nofill"></path>
  </g>
  <g>
    <path d="M 304,104 A 4,4 0,0,0 300,108" class="nofill"></path>
    <line x1="300" y1="108" x2="300" y2="132" class="solid"></line>
    <line x1="304" y1="104" x2="544" y2="104" class="solid"></line>
    <path d="M 544,104 A 4,4 0,0,1 548,108" class="nofill"></path>
    <line x1="548" y1="108" x2="548" y2="132" class="solid"></line>
    <path d="M 300,132 A 4,4 0,0,0 304,136" class="nofill"></path>
    <line x1="304" y1="136" x2="544" y2="136" class="solid"></line>
    <line x1="420" y1="136" x2="420" y2="164" class="solid"></line>
    <path d="M 548,132 A 4,4 0,0,1 544,136" class="nofill"></path>
    <polygon points="416,164 424,164 420,176" class="filled"></polygon>
  </g>
  <g>
    <path d="M 352,168 A 4,4 0,0,0 348,172" class="nofill"></path>
    <line x1="348" y1="172" x2="348" y2="196" class="solid"></line>
    <line x1="352" y1="168" x2="416" y2="168" class="solid"></line>
    <path d="M 348,196 A 4,4 0,0,0 352,200" class="nofill"></path>
    <line x1="352" y1="200" x2="496" y2="200" class="solid"></line>
    <line x1="424" y1="168" x2="496" y2="168" class="solid"></line>
    <path d="M 496,168 A 4,4 0,0,1 500,172" class="nofill"></path>
    <line x1="500" y1="172" x2="500" y2="196" class="solid"></line>
    <path d="M 500,196 A 4,4 0,0,1 496,200" class="nofill"></path>
  </g>
</svg></pre>
<p>All business logic will be located in a <code>App</code> struct.</p>
<pre><code class="language-rust">#[derive(Default)]
struct App {
  counter: i64,
}

impl App {
  fn handle_events(&amp;mut self, event: Option&lt;Event&gt;) -&gt; Action {
    match event {
      Some(Event::Quit) =&gt; Action::Quit,
      Some(Event::AppTick) =&gt; Action::Tick,
      Some(Event::Render) =&gt; Action::Render,
      Some(Event::Key(key_event)) =&gt; {
        if let Some(key) = event {
            match key.code {
              KeyCode::Char('j') =&gt; Action::Increment,
              KeyCode::Char('k') =&gt; Action::Decrement
              _ =&gt; {}
          }
        }
      },
      Some(_) =&gt; Action::Noop,
      None =&gt; Action::Noop,
    }
  }

  fn update(&amp;mut self, action: Action) {
    match action {
      Action::Tick =&gt; self.tick(),
      Action::Increment =&gt; self.increment(),
      Action::Decrement =&gt; self.decrement(),
  }

  fn increment(&amp;mut self) {
    self.counter += 1;
  }

  fn decrement(&amp;mut self) {
    self.counter -= 1;
  }

  fn render(&amp;mut self, f: &amp;mut Frame&lt;'_&gt;) {
    f.render_widget(
      Paragraph::new(format!(
        &quot;Press j or k to increment or decrement.\n\nCounter: {}&quot;,
        self.counter
      ))
    )
  }
}</code></pre>
<p>With that, our <code>App</code> becomes a little more simpler:</p>
<pre><code class="language-rust">pub struct App {
  pub tick_rate: (u64, u64),
  pub component: Home,
  pub should_quit: bool,
}

impl Component {
  pub fn new(tick_rate: (u64, u64)) -&gt; Result&lt;Self&gt; {
    let component = Home::new();
    Ok(Self { tick_rate, component, should_quit: false, should_suspend: false })
  }

  pub async fn run(&amp;mut self) -&gt; Result&lt;()&gt; {
    let (action_tx, mut action_rx) = mpsc::unbounded_channel();

    let mut tui = Tui::new();
    tui.enter()

    loop {
      if let Some(e) = tui.next().await {
        if let Some(action) = self.component.handle_events(Some(e.clone())) {
          action_tx.send(action)?;
        }
      }

      while let Ok(action) = action_rx.try_recv().await {
        match action {
          Action::Render =&gt; tui.draw(|f| self.component.render(f, f.size()))?,
          Action::Quit =&gt; self.should_quit = true,
          _ =&gt; self.component.update(action),
        }
      }
      if self.should_quit {
        tui.stop()?;
        break;
      }
    }
    tui.exit()
    Ok(())
  }
}</code></pre>
<p>Our <code>Component</code> currently does one thing and just one thing (increment and decrement a counter). But
we may want to do more complex things and combine <code>Component</code>s in interesting ways. For example, we
may want to add a text input field as well as show logs conditionally from our TUI application.</p>
<p>In the next sections, we will talk about breaking out our app into various components, with the one
root component called <code>Home</code>. And we’ll introduce a <code>Component</code> trait so it is easier to understand
where the TUI specific code ends and where our app’s business logic begins.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="03-structure.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="05-structure.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="03-structure.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="05-structure.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
